<!DOCTYPE html>
<html>
    <head>
        <title>Ward Directory</title>
        <link href="https://fonts.googleapis.com/css?family=Arimo" rel="stylesheet">
        <link rel="stylesheet" href="/styles.css">
    </head>
    <body style="position: relative">
        <div id="app">
            <div class="header">
                <h1>The {{wardName}} Ward Directory</h1>
                <p v-if="user">Welcome {{user.firstname}} {{user.lastname}}!<br><a href="#" @click="logout">Logout</a></p>
                <p v-else><a href="#" @click="toggleForm">Login</a></p>
            </div>
            <!--select>
                <option selected="selected">Blah</option>
                <option selected="false">Boo</option>
            </select-->
            <!--Login form-->
            <transition v-if="showFormUsername" name="modal">
                <div class="modal-mask">
                  <div class="modal-wrapper">
                    <div class="modal-container">
                      <div class="modal-header">
                        <h1 class="modal-title">Register or Login</h1>
                      </div>
                      <div class="modal-body">
                        <p v-if="error" class="error">{{error}}</p>
                        <p v-if="message" class="message">{{message}}</p>
                        <label>Email</label>
                        <br>
                        <input v-model="username">
                      </div>
                      <div class="modal-footer">
                        <button @click="verifyUsername" type="button">Continue</button>
                        <button @click="toggleForm" type="button" class="close">Close</button>
                      </div>
                    </div>
                  </div>
                </div>
            </transition>

            <transition v-if="showFormPassword" name="modal">
                <div class="modal-mask">
                  <div class="modal-wrapper">
                    <div class="modal-container">
                      <div class="modal-header">
                        <h1 class="modal-title">Register or Login</h1>
                      </div>
                      <div class="modal-body">
                        <p v-if="error" class="error">{{error}}</p>
                        <p v-if="message" class="message">{{message}}</p>
                        <label>Password</label>
                        <br>
                        <input type="password" v-model="password">
                      </div>
                      <div class="modal-footer">
                        <button @click="backForm" type="button" class="other">Back</button>
                        <button @click="forgotPassword" type="button">Forgot Password?</button>
                        <button @click="login" type="button" class="other">Login</button>
                        <button @click="closeForm" type="button" class="close">Close</button>
                      </div>
                    </div>
                  </div>
                </div>
            </transition>

            <!--Photo Editor-->
            <transition v-if="showPhotoEditor" name="peditor">
                <div class="peditor-mask">
                    <div class="peditor-wrapper">
                        <div class="peditor-container">
                            <div class="peditor-header">
                                <h1 class="peditor-title">Photo editor</h1>
                            </div>
                            <div class="peditor-body">
                                <canvas id="canvas">The browser is too old.</canvas>
                            </div>
                            <div class="peditor-footer">
                                <input type="file" ref="file" @change="loadImage">
                                <button @click="saveImage" type="button">Save</button>
                                <button @click="togglePhotoEditor" type="button" class="close">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </transition>

            <transition v-if="showBatchForm" name="modal">
                <div class="modal-mask">
                  <div class="modal-wrapper">
                    <div class="modal-container">
                      <div class="modal-header">
                        <h1 class="modal-title">Add Batch</h1>
                      </div>
                      <div class="modal-body">
                        <textarea v-model="batchData">

                        </textarea>
                      </div>
                      <div class="modal-footer">
                        <button @click="addBatch" type="button">Submit</button>
                        <button @click="toggleBatchForm" type="button">Cancel</button>
                      </div>
                    </div>
                  </div>
                </div>
            </transition>

            <div class="sidebar">
                <div class="sidebarinner" id="leftMenu">
                    <div v-if="user" class="sidebarinnerinner">
                        <h4 class="option" @click="filterMembers('Bishopric')" :class="(currApt == 'Bishopric') ? 'active' : false">Bishopric</h4>
                        <h4 class="option" @click="showLeadership()" :class="(currApt == 'leadership') ? 'active' : false">Leadership</h4>
                        <h4>Apartments</h4>
                        <p v-for="apartment in apartments" @click="filterMembers(apartment)" :class="(apartment == currApt) ? 'active' : false">{{apartment}}</p>
                    </div>
                </div>
            </div>

            <div class="content">
                <div v-for="member in memberSubset" @mouseover="currMember = member._id" @mouseleave="currMember = ''" class="member-info">
                    <div v-if="member.hidden && member._id != editId" class="hidden-member">
                        <p v-if="currMember == member._id">This member is temporarily hidden. 
                            Either they will be coming back eventually or they have moved out for good. 
                            If you know they aren't coming back (e.g. they got married), please let me know!
                        </p>
                    </div>
                    <img :src="'/photos/' + photoPath(member) + '.jpg?t=' + member.photo" :alt="photoAlt(member.firstname, member.lastname)" :class="(currApt == 'Bishopric')? 'control' : false">
                    <div v-if="member._id != editId">
                        <p>{{member.firstname}} {{member.lastname}}</p>
                        <p>{{member.email}}</p>
                        <p>{{member.phone}}</p>
                        <p v-if="currApt == 'Bishopric'">{{member.address}}</p>
                    </div>
                    <div v-else class="input-block">
                        <button v-if="currApt != 'Bishopric'" @click="togglePhotoEditor(member.photo)" type="button">Edit Photo</button>
                        <span v-else>
                            <label for="updateBishopricPhoto">New Photo: </label>
                            <input type="file" @change="loadFile" id="updateBishopricPhoto">
                        </span>
                        <input v-model="editedFirstname" placeholder="First Name">
                        <input v-model="editedLastname" placeholder="Last Name">
                        <input v-model="editedEmail" placeholder="Email">
                        <input v-model="editedPhone" placeholder="Phone">
                        <input v-if="currApt == 'Bishopric'" v-model="address" placeholder="Address">
                        <label v-if="hasPermissions(member)" for="permissions">Permissions: </label>
                        <select v-if="hasPermissions(member)" @change="changePermissions(member)" v-model="permissionLevel" id="permissions">
                            <option v-for="n in user.permissions" :value="n - 1">{{n - 1}}</option>
                        </select>
                        <div>
                            <label for="hiddenField">Member hidden</label>
                            <input v-model="hiddenMember" type="checkbox" id="hiddenField" @change="changeHiddenState(member)">
                        </div>
                    </div>
                    <div v-if="currMember == member._id && user.permissions > 0" class="edit-options">
                        <button v-if="member._id != editId" @click="editMember(member)" type="button">Edit</button>
                        <button v-else type="button" @click="updateMember(member)">Save</button>
                        <button v-if="member._id != editId" @click="deleteMember(member)" class="delete" type="button">Delete</button>
                        <button v-else type="button" @click="editId = ''">Cancel</button>
                    </div>
                </div>
                <div v-if="showAddTile" class="member-info input-block" style="padding-top: 300px;">
                    <span v-if="currApt == 'Bishopric'">
                        <label for="addBishopricPhoto">Photo: </label>
                        <input type="file" @change="loadFile" id="addBishopricPhoto">
                    </span>
                    <input v-model="addedFirstname" placeholder="First Name">
                    <input v-model="addedLastname" placeholder="Last Name">
                    <input v-model="addedEmail" placeholder="Email">
                    <input v-model="addedPhone" placeholder="Phone">
                    <div class="edit-options">
                        <button @click="addMember(currApt)" type="button">Add</button>
                        <button @click="toggleAddField" type="button">Cancel</button>
                    </div>
                </div>
                <button v-if="showAddButton()" @click="toggleAddField" type="button">Add member</button>

                <div v-if="currApt =='leadership'">
                    <table style="width:800px">
                        <tr>
                            <th>Callings</th>
                            <th>Name</th>
                        </tr>
                    </table>
                    <div v-for="(value, category) in callings">
                        <h4>{{category}}</h4>
                        <table style="width:800px">
                            <tr v-for="(member, name) in value">
                                <td>{{name}}:</td>
                                <td><span v-if="member">{{member.firstname}} {{member.lastname}}</span>
                                    <button v-if="callingField != (category+name) && user.permissions > 0" type="button" @click="callingField = (category+name)">Edit</button>
                                    <select v-if="callingField == (category+name)" v-model="editId">
                                        <option>Choose a member</option>
                                        <option v-for="m in members" :value="m._id">{{m.firstname}} {{m.lastname}}</option>
                                    </select>
                                    <button v-if="callingField == (category+name)" @click="updateCalling(editId, category + ';' + name)">Save</button>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>

                <p v-if="user && !currApt">
                    Welcome! To get started, click one of the apartments to the left. 
                    You may download a booklet if you want to print one out.  
                    If you find any errors or if you do not want certain information to be displayed, 
                    you may contact the current Ward Clerk over Membership. 
                </p>
            </div>

            <p v-if="!user" style="margin: 0px 200px">
                Welcome to the Ward Directory! If you have an account, you can click on Login and enter your email address 
                to proceed. If you attempt to login but can't, instructions will be shown indicating what you should do. 
                If you do not have an account, I will soon provide an example login to see the features of this application. 
                I hope you find this useful!
            </p>

            <!--div class="sidebar"-->
                <div id="rightMenu" class="sidebarinner" style="right:0">
                    <div v-if="user" class="sidebarinnerinner booklet">
                        <p>Booklet type:</p>
                        <button type="button" class="type" :class="byapartment" @click="toggleBookletType" :disabled="byapartment.current">By Apartment</button>
                        <button type="button" class="type" :class="alphabetical" @click="toggleBookletType" :disabled="alphabetical.current">Alphabetically</button>
                        <div style="height: 30px;"></div>
                        <a :href="'/api/booklet?type=' + bookletType">Download Current Booklet</a>
                        <br>
                        <div v-if="user.permissions > 2">
                            <p style="text-align: center;">Clerk tools</p>
                            <button type="button" @click="generateBooklet">Generate Booklet</button>
                            <a v-for="name in oldBooklets" :href="'/api/booklet/' + name">{{name.split("_").slice(0, 2).join(" ")}}</a>
                            <button style="margin-top: 40px" type="button" @click="toggleBatchForm">Add Batch</button>
                        </div>
                    </div>
                </div>
            <!--/div-->

            <!-- Not ready for this yet. 
            <a style="float:right" href="/api/booklet">Generate Booklet</a>
            -->
        </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js" integrity="sha256-mpnrJ5DpEZZkwkE1ZgkEQQJW/46CSEh/STrZKOB/qoM=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.7/vue.js" integrity="sha256-g+Q8DFAmG5+eyRPSydX0LY4TfjsL11XSDrIGerbbEdA=" crossorigin="anonymous"></script>
        <script src="/script.js"></script>
        <script src="/photos.js"></script>
    </body>
</html>