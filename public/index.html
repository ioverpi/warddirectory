<!DOCTYPE html>
<html>
    <head>
        <title>Ward Directory</title>
        <link href="https://fonts.googleapis.com/css?family=Arimo" rel="stylesheet">
        <link rel="stylesheet" href="/styles.css">
    </head>
    <body style="position: relative">
        <div id="app">
            <div class="header">
                <h1>32nd Ward Directory</h1>
                <p v-if="user">Welcome {{user.firstname}} {{user.lastname}}!<br><a href="#" @click="logout">Logout</a></p>
                <p v-else><a href="#" @click="toggleForm">Login</a></p>
            </div>
            <!--select>
                <option selected="selected">Blah</option>
                <option selected="false">Boo</option>
            </select-->
            <!--Login form-->
            <transition v-if="showForm" name="modal">
                <div class="modal-mask">
                  <div class="modal-wrapper">
                    <div class="modal-container">
                      <div class="modal-header">
                        <h1 class="modal-title">Register or Login</h1>
                      </div>
                      <div class="modal-body">
                        <p v-if="error" class="error">{{error}}</p>
                        <p v-if="message" class="message">{{message}}</p>
                        <label>Email</label>
                        <br />
                        <input v-model="username">
                        <br>
                        <label>Password</label>
                        <br>
                        <input type="password" v-model="password">
                      </div>
                      <div class="modal-footer">
                        <button @click="forgotPassword" type="button">Reset Password</button>
                        <button @click="login" type="button" class="other">Login</button>
                        <button @click="toggleForm" type="button" class="close">Close</button>
                      </div>
                    </div>
                  </div>
                </div>
            </transition>

            <!--Photo Editor-->
            <transition v-if="showPhotoEditor" name="peditor">
                <div class="peditor-mask">
                    <div class="peditor-wrapper">
                        <div class="peditor-container">
                            <div class="peditor-header">
                                <h1 class="peditor-title">Photo editor</h1>
                            </div>
                            <div class="peditor-body">
                                <canvas id="canvas">The browser is too old.</canvas>
                            </div>
                            <div class="peditor-footer">
                                <input type="file" ref="file" @change="loadImage">
                                <button @click="saveImage" type="button">Save</button>
                                <button @click="togglePhotoEditor" type="button" class="close">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </transition>

            <div class="sidebar">
                <div class="sidebarinner">
                    <div class="sidebarinnerinner">
                        <h4 class="option" @click="filterMembers('Bishopric')" :class="(currApt == 'Bishopric') ? 'active' : false">Bishopric</h4>
                        <h4 class="option" @click="showLeadership()" :class="(currApt == 'leadership') ? 'active' : false">Leadership</h4>
                        <h4>Apartments</h4>
                        <p v-for="apartment in apartments" @click="filterMembers(apartment)" :class="(apartment == currApt) ? 'active' : false">{{apartment}}</p>
                    </div>
                </div>
            </div>

            <div class="content put-in-content">
                <div v-for="member in memberSubset" @mouseover="currMember = member._id" @mouseleave="currMember = ''" class="member-info">
                    <img :src="'/photos/' + photoPath(member) + '.jpg?t=' + member.photo" :alt="photoAlt(member.firstname, member.lastname)" :class="(currApt == 'Bishopric')? 'control' : false">
                    <div v-if="member._id != editId">
                        <p>{{member.firstname}} {{member.lastname}}</p>
                        <p>{{member.email}}</p>
                        <p>{{member.phone}}</p>
                        <p v-if="currApt == 'Bishopric'">{{member.address}}</p>
                    </div>
                    <div v-else class="input-block">
                        <button v-if="currApt != 'Bishopric'" @click="togglePhotoEditor(member.photo)" type="button">Edit Photo</button>
                        <span v-else>
                            <label for="updateBishopricPhoto">New Photo: </label>
                            <input type="file" ref="file2" id="updateBishopricPhoto">
                        </span>
                        <input v-model="editedFirstname" placeholder="First Name">
                        <input v-model="editedLastname" placeholder="Last Name">
                        <input v-model="editedEmail" placeholder="Email">
                        <input v-model="editedPhone" placeholder="Phone">
                        <input v-if="currApt == 'Bishopric'" v-model="address" placeholder="Address">
                        <label v-if="hasPermissions(member)" for="permissions">Permissions: </label>
                        <select v-if="hasPermissions(member)" @change="changePermissions(member)" v-model="permissionLevel" id="permissions">
                            <option v-for="n in user.permissions" :value="n - 1">{{n - 1}}</option>
                        </select>
                    </div>
                    <div v-if="currMember == member._id && user.permissions > 0" class="edit-options">
                        <button v-if="member._id != editId" @click="editMember(member)" type="button">Edit</button>
                        <button v-else type="button" @click="updateMember(member)">Save</button>
                        <button v-if="member._id != editId" @click="deleteMember(member)" class="delete" type="button">Delete</button>
                        <button v-else type="button" @click="editId = ''">Cancel</button>
                    </div>
                </div>
                <div v-if="showAddTile" class="member-info input-block" style="padding-top: 300px;">
                    <span v-if="currApt == 'Bishopric'">
                        <label for="addBishopricPhoto">Photo: </label>
                        <input type="file" @change="loadFile" id="addBishopricPhoto">
                    </span>
                    <input v-model="addedFirstname" placeholder="First Name">
                    <input v-model="addedLastname" placeholder="Last Name">
                    <input v-model="addedEmail" placeholder="Email">
                    <input v-model="addedPhone" placeholder="Phone">
                    <div class="edit-options">
                        <button @click="addMember(currApt)" type="button">Add</button>
                        <button @click="toggleAddField" type="button">Cancel</button>
                    </div>
                </div>
                <button v-if="showAddButton()" @click="toggleAddField" type="button">Add member</button>

                <div v-if="currApt =='leadership'">
                    <table style="width:800px">
                        <tr>
                            <th>Callings</th>
                            <th>Name</th>
                        </tr>
                    </table>
                    <div v-for="(value, category) in callings">
                        <h4>{{category}}</h4>
                        <table style="width:800px">
                            <tr v-for="(member, name) in value">
                                <td>{{name}}:</td>
                                <td><span v-if="member">{{member.firstname}} {{member.lastname}}</span>
                                    <button v-if="callingField != (category+name)" type="button" @click="callingField = (category+name)">Edit</button>
                                    <select v-if="callingField == (category+name)" v-model="editId">
                                        <option>Choose a member</option>
                                        <option v-for="m in members" :value="m._id">{{m.firstname}} {{m.lastname}}</option>
                                    </select>
                                    <p v-if="callingField != (category+name) && (category == 'Bishopric' || name == 'Ward Clerk')">{{member.address}}</p>
                                    <input v-if="callingField == (category+name) && (category == 'Bishopric' || name == 'Ward Clerk')" v-model="address" placeholder="Address">
                                    <button v-if="callingField == (category+name)" @click="updateCalling(editId, category + ';' + name)">Save</button>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <a style="float:right" href="/api/booklet">Generate Booklet</a>
        </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js" integrity="sha256-mpnrJ5DpEZZkwkE1ZgkEQQJW/46CSEh/STrZKOB/qoM=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.7/vue.js" integrity="sha256-g+Q8DFAmG5+eyRPSydX0LY4TfjsL11XSDrIGerbbEdA=" crossorigin="anonymous"></script>
        <script src="/script.js"></script>
        <script src="/photos.js"></script>
    </body>
</html>